<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>お会計スキャナー</title>
    <meta name="theme-color" content="#4CAF50">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">

    <style>
        /* モバイルファーストなスタイル定義 */
        :root {
            --primary-color: #4CAF50;
            --bg-color: #f4f4f4;
            --text-color: #333;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        header {
            width: 100%;
            background-color: var(--primary-color);
            color: white;
            padding: 1rem 0;
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        main {
            width: 100%;
            max-width: 600px;
            padding: 1rem;
            box-sizing: border-box;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        /* カメラ表示エリア */
        #reader {
            width: 100%;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        /* 結果表示カード */
        #result-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
            display: none; /* 初期状態は非表示 */
        }
        #result-card.active {
            display: block;
            animation: popIn 0.3s ease-out;
        }
        .product-name {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: var(--text-color);
        }
        .product-price {
            font-size: 2rem;
            color: #e91e63;
            font-weight: bold;
        }
        .unknown-item {
            color: #888;
            font-size: 1.2rem;
        }

        /* アクションボタン */
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 1rem;
            border-radius: 50px;
            cursor: pointer;
            width: 100%;
            margin-top: 1rem;
            touch-action: manipulation; /* タッチ遅延解消 */
        }
        button:active {
            transform: scale(0.98);
        }

        @keyframes popIn {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* html5-qrcodeの微調整 */
        #reader__scan_region img { display: none; } /* 不要な画像を消す */
    </style>
</head>
<body>

    <header>ポケットレジ PWA</header>

    <main>
        <div id="reader"></div>

        <div id="result-card">
            <div id="display-name" class="product-name">商品名</div>
            <div id="display-price" class="product-price">\0</div>
            <button onclick="resetScanner()">次の商品をスキャン</button>
        </div>
        
        <div style="font-size: 0.8rem; color: #666; margin-top: 2rem;">
            <p><strong>動作確認用JANコード（ダミー）:</strong></p>
            <ul>
                <li>4901330502881 (ポテトチップス)</li>
                <li>4902105033746 (カップヌードル)</li>
                <li>4549131970258 (単三電池)</li>
            </ul>
        </div>
    </main>

    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <script>
        // PWA Service Workerの登録
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW registered!', reg))
                    .catch(err => console.log('SW failed', err));
            });
        }

        // 1. ダミーデータ定義 (JANコードをキーにする)
        const productDB = {
            '4901330502881': { name: 'ポテトチップス うすしお', price: 108 },
            '4902105033746': { name: 'カップヌードル シーフード', price: 214 },
            '4901777284136': { name: '伊右衛門 600ml', price: 160 },
            '4549131970258': { name: 'DAISO アルカリ乾電池', price: 110 },
            '4902777008763': { name: '明治ミルクチョコレート', price: 130 }
        };

        let html5QrcodeScanner = null;

        // 2. スキャン成功時の処理
        function onScanSuccess(decodedText, decodedResult) {
            // 連続スキャンを防ぐために一時停止
            if (html5QrcodeScanner) {
                html5QrcodeScanner.clear(); 
            }

            const resultCard = document.getElementById('result-card');
            const nameEl = document.getElementById('display-name');
            const priceEl = document.getElementById('display-price');
            const readerEl = document.getElementById('reader');

            readerEl.style.display = 'none'; // カメラを隠す
            resultCard.className = 'active'; // 結果を表示

            // データ照合
            const item = productDB[decodedText];
            if (item) {
                nameEl.textContent = item.name;
                nameEl.classList.remove('unknown-item');
                priceEl.textContent = `\${item.price}`;
                // 効果音などを鳴らすならここ
            } else {
                nameEl.textContent = `未登録の商品: ${decodedText}`;
                nameEl.classList.add('unknown-item');
                priceEl.textContent = '---';
            }
        }

        function onScanFailure(error) {
            // スキャン中の軽微なエラーは無視（コンソールが汚れるため）
        }

        // 3. スキャナー起動
        function startScanner() {
            // UI付きのスキャナーを初期化
            html5QrcodeScanner = new Html5QrcodeScanner(
                "reader", 
                { fps: 10, qrbox: { width: 250, height: 250 } },
                /* verbose= */ false
            );
            html5QrcodeScanner.render(onScanSuccess, onScanFailure);
        }

        // 4. リセット（再スキャン）
        function resetScanner() {
            document.getElementById('result-card').className = ''; // 結果を隠す
            document.getElementById('result-card').style.display = 'none';
            document.getElementById('reader').style.display = 'block'; // カメラを表示
            startScanner();
        }

        // 初期起動
        startScanner();

    </script>
</body>
</html>